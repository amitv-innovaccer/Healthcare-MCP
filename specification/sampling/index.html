
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://amitv-innovaccer.github.io/Healthcare-MCP/specification/sampling/" rel="canonical"/>
<link href="../guardrails/" rel="prev"/>
<link href="../hmcp_python_sdk/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.12" name="generator"/>
<title>Sampling - Healthcare-MCP Docs</title>
<link href="../../assets/stylesheets/main.2afb09e1.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#agent-to-agent-bidirectional-communication">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Healthcare-MCP Docs" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Healthcare-MCP Docs">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Healthcare-MCP Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Sampling
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../">
          
  
  
  Specification

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../hmcp_python_sdk/">
          
  
  
  SDK

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../tutorial/">
          
  
  
  Tutorial

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Healthcare-MCP Docs" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Healthcare-MCP Docs">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    Healthcare-MCP Docs
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
<span class="md-ellipsis">
    Specification
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Specification
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Introduction
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../context/">
<span class="md-ellipsis">
    Context
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../auth/">
<span class="md-ellipsis">
    Auth
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../hmcp_auth_vs_mcp_auth/">
<span class="md-ellipsis">
    HMCP Auth vs MCP Auth
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../guardrails/">
<span class="md-ellipsis">
    Guardrails
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Sampling
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Sampling
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      Overview
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#capabilities-and-advertisement">
<span class="md-ellipsis">
      Capabilities and Advertisement
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-and-configuration">
<span class="md-ellipsis">
      Implementation and Configuration
    </span>
</a>
<nav aria-label="Implementation and Configuration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#server-side-implementation">
<span class="md-ellipsis">
      Server-Side Implementation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#client-side-implementation">
<span class="md-ellipsis">
      Client-Side Implementation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#message-structure">
<span class="md-ellipsis">
      Message Structure
    </span>
</a>
<nav aria-label="Message Structure" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#client-to-server-request">
<span class="md-ellipsis">
      Client to Server Request
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#server-to-client-response">
<span class="md-ellipsis">
      Server to Client Response
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#follow-up-client-request-with-additional-data">
<span class="md-ellipsis">
      Follow-up Client Request with Additional Data
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#error-response-when-guardrails-block-a-request">
<span class="md-ellipsis">
      Error Response (When Guardrails Block a Request)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#message-flow-in-a-multi-agent-system">
<span class="md-ellipsis">
      Message Flow in a Multi-Agent System
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#security-and-guardrails-in-bidirectional-communication">
<span class="md-ellipsis">
      Security and Guardrails in Bidirectional Communication
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#use-cases-for-bidirectional-agent-communication">
<span class="md-ellipsis">
      Use Cases for Bidirectional Agent Communication
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    SDK
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            SDK
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../hmcp_python_sdk/">
<span class="md-ellipsis">
    HMCP Python SDK
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../examples/">
<span class="md-ellipsis">
    HMCP Examples
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Tutorial
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../tutorial/">
<span class="md-ellipsis">
    Introduction
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tutorial/01_hmcp_server_/">
<span class="md-ellipsis">
    01 HMCP Server
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tutorial/02_hmcp_client_/">
<span class="md-ellipsis">
    02 HMCP Client
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tutorial/03_authentication__oauth___jwt__/">
<span class="md-ellipsis">
    03 Authentication (OAuth &amp; JWT)
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tutorial/04_sampling_functionality_/">
<span class="md-ellipsis">
    04 Sampling Functionality
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tutorial/05_guardrails_/">
<span class="md-ellipsis">
    05 Guardrails
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tutorial/06_auth_configuration_/">
<span class="md-ellipsis">
    06 Auth Configuration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tutorial/07_jwt_handler_/">
<span class="md-ellipsis">
    07 JWT Handler
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      Overview
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#capabilities-and-advertisement">
<span class="md-ellipsis">
      Capabilities and Advertisement
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-and-configuration">
<span class="md-ellipsis">
      Implementation and Configuration
    </span>
</a>
<nav aria-label="Implementation and Configuration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#server-side-implementation">
<span class="md-ellipsis">
      Server-Side Implementation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#client-side-implementation">
<span class="md-ellipsis">
      Client-Side Implementation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#message-structure">
<span class="md-ellipsis">
      Message Structure
    </span>
</a>
<nav aria-label="Message Structure" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#client-to-server-request">
<span class="md-ellipsis">
      Client to Server Request
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#server-to-client-response">
<span class="md-ellipsis">
      Server to Client Response
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#follow-up-client-request-with-additional-data">
<span class="md-ellipsis">
      Follow-up Client Request with Additional Data
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#error-response-when-guardrails-block-a-request">
<span class="md-ellipsis">
      Error Response (When Guardrails Block a Request)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#message-flow-in-a-multi-agent-system">
<span class="md-ellipsis">
      Message Flow in a Multi-Agent System
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#security-and-guardrails-in-bidirectional-communication">
<span class="md-ellipsis">
      Security and Guardrails in Bidirectional Communication
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#use-cases-for-bidirectional-agent-communication">
<span class="md-ellipsis">
      Use Cases for Bidirectional Agent Communication
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="agent-to-agent-bidirectional-communication">Agent to Agent Bidirectional Communication</h1>
<p>Agent to agent bidirectional communication is implemented by adding <a href="https://modelcontextprotocol.io/specification/2025-03-26/client/sampling">sampling</a> capability to the HMCP server. The base MCP implementation already has sampling implemented on the client. That way HMCP client and server both can communicate using LLM inputs and output.</p>
<h2 id="overview">Overview</h2>
<p>In standard MCP, only servers can request language model generations or completions from clients. HMCP extends this functionality by implementing sampling capabilities on servers as well, enabling bidirectional communication between AI agents. This allows for:</p>
<ul>
<li>Multiple agents to collaborate on complex healthcare workflows with security and compliance guarantees</li>
</ul>
<h2 id="capabilities-and-advertisement">Capabilities and Advertisement</h2>
<p>HMCP Server defines <code>sampling</code> as a sub-capability under the <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/lifecycle#capability-negotiation">experimental</a> capability. During initialization, an HMCP server advertises its sampling capabilities to clients:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"capabilities"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"experimental"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"hmcp"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">"sampling"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>This advertisement ensures clients are aware of the server's ability to handle sampling requests.</p>
<h2 id="implementation-and-configuration">Implementation and Configuration</h2>
<h3 id="server-side-implementation">Server-Side Implementation</h3>
<p>To implement an HMCP server with bidirectional communication:</p>
<ol>
<li><strong>Create an HMCPServer instance:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">hmcp.mcpserver.hmcp_server</span><span class="w"> </span><span class="kn">import</span> <span class="n">HMCPServer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hmcp.mcpserver.guardrail</span><span class="w"> </span><span class="kn">import</span> <span class="n">Guardrail</span>

<span class="c1"># Initialize the server</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">HMCPServer</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"Healthcare Agent"</span><span class="p">,</span>
    <span class="n">version</span><span class="o">=</span><span class="s2">"1.0.0"</span><span class="p">,</span>
    <span class="n">host</span><span class="o">=</span><span class="s2">"0.0.0.0"</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">8050</span><span class="p">,</span>
    <span class="n">instructions</span><span class="o">=</span><span class="s2">"This agent provides healthcare information services."</span>
<span class="p">)</span>

<span class="c1"># Optional: Initialize guardrail for security</span>
<span class="n">guardrail</span> <span class="o">=</span> <span class="n">Guardrail</span><span class="p">()</span>
</code></pre></div>
<ol>
<li><strong>Register a sampling callback function:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nd">@server</span><span class="o">.</span><span class="n">sampling</span><span class="p">()</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_sampling_requests</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Process incoming sampling requests."""</span>
    <span class="c1"># Extract the message content</span>
    <span class="n">latest_message</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">message_content</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latest_message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">TextContent</span><span class="p">):</span>
        <span class="n">message_content</span> <span class="o">=</span> <span class="n">latest_message</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">text</span>

    <span class="c1"># Optional: Apply guardrails for security</span>
    <span class="k">await</span> <span class="n">guardrail</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">message_content</span><span class="p">)</span>

    <span class="c1"># Process the message and generate a response</span>
    <span class="c1"># ...custom processing logic...</span>

    <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">CreateMessageResult</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">"healthcare-model"</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="s2">"assistant"</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">TextContent</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">"text"</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="s2">"Response to the client's request"</span>
        <span class="p">),</span>
        <span class="n">stopReason</span><span class="o">=</span><span class="s2">"endTurn"</span>
    <span class="p">)</span>
</code></pre></div>
<ol>
<li><strong>Run the server:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># Start the server with SSE transport</span>
<span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">transport</span><span class="o">=</span><span class="s2">"sse"</span><span class="p">)</span>
</code></pre></div>
<h3 id="client-side-implementation">Client-Side Implementation</h3>
<p>To communicate with an HMCP server that supports sampling:</p>
<ol>
<li><strong>Connect to the server:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">hmcp.mcpclient.hmcp_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">HMCPClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientSession</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mcp.client.sse</span><span class="w"> </span><span class="kn">import</span> <span class="n">sse_client</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mcp.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">SamplingMessage</span><span class="p">,</span> <span class="n">TextContent</span>

<span class="c1"># Authentication setup (if required)</span>
<span class="n">auth_headers</span> <span class="o">=</span> <span class="n">oauth_client</span><span class="o">.</span><span class="n">get_auth_header</span><span class="p">()</span>

<span class="c1"># Connect to the HMCP server</span>
<span class="k">async</span> <span class="k">with</span> <span class="n">sse_client</span><span class="p">(</span><span class="s2">"http://localhost:8050/sse"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">auth_headers</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">read_stream</span><span class="p">,</span> <span class="n">write_stream</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">ClientSession</span><span class="p">(</span><span class="n">read_stream</span><span class="p">,</span> <span class="n">write_stream</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># Initialize the HMCP client</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">HMCPClient</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">init_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</code></pre></div>
<ol>
<li><strong>Send a sampling request:</strong></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># Create a message</span>
<span class="n">message</span> <span class="o">=</span> <span class="n">SamplingMessage</span><span class="p">(</span>
    <span class="n">role</span><span class="o">=</span><span class="s2">"user"</span><span class="p">,</span>
    <span class="n">content</span><span class="o">=</span><span class="n">TextContent</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">"text"</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s2">"What is the recommended treatment for hypertension?"</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Send the request and get a response</span>
<span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">create_message</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="n">message</span><span class="p">])</span>

<span class="c1"># Process the response</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">):</span>
    <span class="n">response_text</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">text</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Agent response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div>
<h2 id="message-structure">Message Structure</h2>
<p>HMCP uses JSON-RPC for message exchange. Below are examples of the actual JSON messages exchanged during bidirectional communication:</p>
<h3 id="client-to-server-request">Client to Server Request</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"jsonrpc"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sampling/createMessage"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span>
<span class="w">          </span><span class="nt">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"clinical_data={\"diagnosis\": \"Hypertension\", \"blood_pressure\": \"140/90\", \"medication\": \"Lisinopril 10mg\"}"</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">"modelPreferences"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"hints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"healthcare-model"</span><span class="p">}</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">"intelligencePriority"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"speedPriority"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">"maxTokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="server-to-client-response">Server to Client Response</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"jsonrpc"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"result"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"assistant"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span>
<span class="w">      </span><span class="nt">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Additional information required: Need patient_id to associate with this clinical data."</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">"emr-writeback-agent"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"stopReason"</span><span class="p">:</span><span class="w"> </span><span class="s2">"endTurn"</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="follow-up-client-request-with-additional-data">Follow-up Client Request with Additional Data</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"jsonrpc"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sampling/createMessage"</span><span class="p">,</span>
<span class="w">  </span><span class="nt">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"messages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span>
<span class="w">        </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span>
<span class="w">          </span><span class="nt">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"clinical_data={\"diagnosis\": \"Hypertension\", \"blood_pressure\": \"140/90\", \"medication\": \"Lisinopril 10mg\"} patient_id=PT12345"</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">"maxTokens"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="error-response-when-guardrails-block-a-request">Error Response (When Guardrails Block a Request)</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">"jsonrpc"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nt">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nt">"error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Request blocked by guardrails"</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="message-flow-in-a-multi-agent-system">Message Flow in a Multi-Agent System</h2>
<p>The following diagram depicts the message flow in a multi-agent healthcare scenario as implemented in the HMCP Demo:</p>
<div class="mermaid">sequenceDiagram
    participant AI as AI Agent (Orchestrator)
    participant EMR as EMR Writeback Agent
    participant Patient as Patient Data Access Agent

    Note over AI,Patient: Workflow initialization

    AI-&gt;&gt;EMR: Start EMR Agent (StdioServerParameters)
    Note right of EMR: EMR Agent initializes<br/>with HMCPServer and<br/>registers sampling handler
    EMR--&gt;&gt;AI: Initialization response

    AI-&gt;&gt;Patient: Start Patient Agent (StdioServerParameters)
    Note right of Patient: Patient Agent initializes<br/>with HMCPServer and<br/>registers sampling handler
    Patient--&gt;&gt;AI: Initialization response

    AI-&gt;&gt;EMR: Connect to EMR via ClientSession
    EMR--&gt;&gt;AI: Connection established (emr_init_result)

    Note over AI,EMR: First clinical data request
    AI-&gt;&gt;EMR: create_message([clinical_data_message])
    Note right of EMR: Invokes handle_emr_writeback_sampling()
    EMR--&gt;&gt;AI: "Additional information required: Need patient_id"

    AI-&gt;&gt;Patient: Connect to Patient Agent via ClientSession
    Patient--&gt;&gt;AI: Connection established (patient_init_result)

    Note over AI,Patient: Patient ID request
    AI-&gt;&gt;Patient: create_message([patient_request_message])
    Note right of Patient: Invokes handle_patient_data_sampling()
    Patient--&gt;&gt;AI: "Patient identifier for John Smith: patient_id=PT12345"

    Note over AI,EMR: Final clinical data request with ID
    AI-&gt;&gt;EMR: create_message([clinical_data_with_id_message])
    Note right of EMR: Invokes handle_emr_writeback_sampling()
    EMR--&gt;&gt;AI: "Success: Clinical data has been written to the EMR system"

    Note over AI,Patient: Workflow completed
</div>
<h2 id="security-and-guardrails-in-bidirectional-communication">Security and Guardrails in Bidirectional Communication</h2>
<p>Bidirectional communication introduces additional security concerns. HMCP addresses these with:</p>
<ol>
<li><strong>Authentication and Authorization</strong>: All sampling requests require OAuth 2.0 authentication with appropriate scopes</li>
<li><strong>Guardrails</strong>: Automatic validation of all messages passing between agents to prevent prompt injection</li>
<li><strong>Audit Logging</strong>: Comprehensive logging of all communications for compliance requirements</li>
</ol>
<p>Example of a sampling request blocked by guardrails:</p>
<div class="mermaid">sequenceDiagram
    participant AI as AI Agent
    participant Guard as Guardrail System
    participant HMCP as HMCP Server

    AI-&gt;&gt;HMCP: Sampling request with prompt injection attempt
    HMCP-&gt;&gt;Guard: Check request against guardrails
    Guard--xHMCP: Block request (contains "system prompt")
    HMCP--xAI: Return GuardrailException
    Note right of AI: Request blocked for security reasons
</div>
<h2 id="use-cases-for-bidirectional-agent-communication">Use Cases for Bidirectional Agent Communication</h2>
<p>HMCP's bidirectional communication enables several healthcare-specific workflows:</p>
<ol>
<li><strong>Clinical Decision Support</strong>: Specialized agents providing evidence-based recommendations</li>
<li><strong>Data Transformation</strong>: Converting unstructured clinical notes to structured data</li>
<li><strong>Multi-agent Workflows</strong>: Complex healthcare processes involving multiple specialized agents</li>
<li><strong>Federated Knowledge</strong>: Accessing domain-specific knowledge without requiring all agents to have complete healthcare knowledge</li>
</ol>
<p>By implementing sampling on both clients and servers, HMCP creates a flexible ecosystem of healthcare AI agents that can collaborate securely and efficiently.</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.highlight", "search.suggest"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>