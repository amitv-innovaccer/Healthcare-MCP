
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://amitv-innovaccer.github.io/Healthcare-MCP/specification/sampling/">
      
      
        <link rel="prev" href="../guardrails/">
      
      
        <link rel="next" href="../../tutorial/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Sampling - Healthcare-MCP Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#agent-to-agent-bidirectional-communication" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Healthcare-MCP Docs" class="md-header__button md-logo" aria-label="Healthcare-MCP Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Healthcare-MCP Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Sampling
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../examples/README.md" class="md-tabs__link">
        
  
  
    
  
  Examples

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../src/hmcp/README.md" class="md-tabs__link">
        
  
  
    
  
  HCMP SDK

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
  Specification

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorial/" class="md-tabs__link">
          
  
  
  Tutorial

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Healthcare-MCP Docs" class="md-nav__button md-logo" aria-label="Healthcare-MCP Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Healthcare-MCP Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/README.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../src/hmcp/README.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HCMP SDK
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Specification
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Specification
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Context
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../auth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Auth
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hmcp_auth_vs_mcp_auth/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HMCP Auth vs MCP Auth
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guardrails/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Guardrails
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Sampling
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Sampling
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capabilities-and-advertisement" class="md-nav__link">
    <span class="md-ellipsis">
      Capabilities and Advertisement
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-and-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation and Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation and Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Server-Side Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Client-Side Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Message Structure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-to-server-request" class="md-nav__link">
    <span class="md-ellipsis">
      Client to Server Request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-to-client-response" class="md-nav__link">
    <span class="md-ellipsis">
      Server to Client Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-up-client-request-with-additional-data" class="md-nav__link">
    <span class="md-ellipsis">
      Follow-up Client Request with Additional Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-response-when-guardrails-block-a-request" class="md-nav__link">
    <span class="md-ellipsis">
      Error Response (When Guardrails Block a Request)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-flow-in-a-multi-agent-system" class="md-nav__link">
    <span class="md-ellipsis">
      Message Flow in a Multi-Agent System
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-and-guardrails-in-bidirectional-communication" class="md-nav__link">
    <span class="md-ellipsis">
      Security and Guardrails in Bidirectional Communication
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-cases-for-bidirectional-agent-communication" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases for Bidirectional Agent Communication
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/01_hmcp_server_/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01 HMCP Server
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/02_hmcp_client_/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    02 HMCP Client
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/03_authentication__oauth___jwt__/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 Authentication (OAuth & JWT)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/04_sampling_functionality_/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    04 Sampling Functionality
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/05_guardrails_/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    05 Guardrails
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/06_auth_configuration_/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    06 Auth Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/07_jwt_handler_/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    07 JWT Handler
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capabilities-and-advertisement" class="md-nav__link">
    <span class="md-ellipsis">
      Capabilities and Advertisement
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-and-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation and Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation and Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Server-Side Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#client-side-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Client-Side Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Message Structure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Message Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client-to-server-request" class="md-nav__link">
    <span class="md-ellipsis">
      Client to Server Request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-to-client-response" class="md-nav__link">
    <span class="md-ellipsis">
      Server to Client Response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-up-client-request-with-additional-data" class="md-nav__link">
    <span class="md-ellipsis">
      Follow-up Client Request with Additional Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-response-when-guardrails-block-a-request" class="md-nav__link">
    <span class="md-ellipsis">
      Error Response (When Guardrails Block a Request)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#message-flow-in-a-multi-agent-system" class="md-nav__link">
    <span class="md-ellipsis">
      Message Flow in a Multi-Agent System
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-and-guardrails-in-bidirectional-communication" class="md-nav__link">
    <span class="md-ellipsis">
      Security and Guardrails in Bidirectional Communication
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-cases-for-bidirectional-agent-communication" class="md-nav__link">
    <span class="md-ellipsis">
      Use Cases for Bidirectional Agent Communication
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="agent-to-agent-bidirectional-communication">Agent to Agent Bidirectional Communication</h1>
<p>Agent to agent bidirectional communication is implemented by adding <a href="https://modelcontextprotocol.io/specification/2025-03-26/client/sampling">sampling</a> capability to the HMCP server. The base MCP implementation already has sampling implemented on the client. That way HMCP client and server both can communicate using LLM inputs and output.</p>
<h2 id="overview">Overview</h2>
<p>In standard MCP, only servers can request language model generations or completions from clients. HMCP extends this functionality by implementing sampling capabilities on servers as well, enabling bidirectional communication between AI agents. This allows for:</p>
<ul>
<li>Multiple agents to collaborate on complex healthcare workflows with security and compliance guarantees</li>
</ul>
<h2 id="capabilities-and-advertisement">Capabilities and Advertisement</h2>
<p>HMCP Server defines <code>sampling</code> as a sub-capability under the <a href="https://modelcontextprotocol.io/specification/2025-03-26/basic/lifecycle#capability-negotiation">experimental</a> capability. During initialization, an HMCP server advertises its sampling capabilities to clients:</p>
<pre><code class="language-json">{
  &quot;capabilities&quot;: {
    &quot;experimental&quot;: {
      &quot;hmcp&quot;: {
        &quot;sampling&quot;: true,
        &quot;version&quot;: &quot;0.1.0&quot;
      }
    }
  }
}
</code></pre>
<p>This advertisement ensures clients are aware of the server's ability to handle sampling requests.</p>
<h2 id="implementation-and-configuration">Implementation and Configuration</h2>
<h3 id="server-side-implementation">Server-Side Implementation</h3>
<p>To implement an HMCP server with bidirectional communication:</p>
<ol>
<li><strong>Create an HMCPServer instance:</strong></li>
</ol>
<pre><code class="language-python">from hmcp.mcpserver.hmcp_server import HMCPServer
from hmcp.mcpserver.guardrail import Guardrail

# Initialize the server
server = HMCPServer(
    name=&quot;Healthcare Agent&quot;,
    version=&quot;1.0.0&quot;,
    host=&quot;0.0.0.0&quot;,
    port=8050,
    instructions=&quot;This agent provides healthcare information services.&quot;
)

# Optional: Initialize guardrail for security
guardrail = Guardrail()
</code></pre>
<ol>
<li><strong>Register a sampling callback function:</strong></li>
</ol>
<pre><code class="language-python">@server.sampling()
async def handle_sampling_requests(context, params):
    &quot;&quot;&quot;Process incoming sampling requests.&quot;&quot;&quot;
    # Extract the message content
    latest_message = params.messages[-1]
    message_content = &quot;&quot;
    if isinstance(latest_message.content, types.TextContent):
        message_content = latest_message.content.text

    # Optional: Apply guardrails for security
    await guardrail.run(message_content)

    # Process the message and generate a response
    # ...custom processing logic...

    return types.CreateMessageResult(
        model=&quot;healthcare-model&quot;,
        role=&quot;assistant&quot;,
        content=types.TextContent(
            type=&quot;text&quot;,
            text=&quot;Response to the client's request&quot;
        ),
        stopReason=&quot;endTurn&quot;
    )
</code></pre>
<ol>
<li><strong>Run the server:</strong></li>
</ol>
<pre><code class="language-python"># Start the server with SSE transport
server.run(transport=&quot;sse&quot;)
</code></pre>
<h3 id="client-side-implementation">Client-Side Implementation</h3>
<p>To communicate with an HMCP server that supports sampling:</p>
<ol>
<li><strong>Connect to the server:</strong></li>
</ol>
<pre><code class="language-python">from hmcp.mcpclient.hmcp_client import HMCPClient
from mcp import ClientSession
from mcp.client.sse import sse_client
from mcp.types import SamplingMessage, TextContent

# Authentication setup (if required)
auth_headers = oauth_client.get_auth_header()

# Connect to the HMCP server
async with sse_client(&quot;http://localhost:8050/sse&quot;, headers=auth_headers) as (read_stream, write_stream):
    async with ClientSession(read_stream, write_stream) as session:
        # Initialize the HMCP client
        client = HMCPClient(session)
        init_result = await session.initialize()
</code></pre>
<ol>
<li><strong>Send a sampling request:</strong></li>
</ol>
<pre><code class="language-python"># Create a message
message = SamplingMessage(
    role=&quot;user&quot;,
    content=TextContent(
        type=&quot;text&quot;,
        text=&quot;What is the recommended treatment for hypertension?&quot;
    )
)

# Send the request and get a response
result = await client.create_message(messages=[message])

# Process the response
if hasattr(result.content, 'text'):
    response_text = result.content.text
    print(f&quot;Agent response: {response_text}&quot;)
</code></pre>
<h2 id="message-structure">Message Structure</h2>
<p>HMCP uses JSON-RPC for message exchange. Below are examples of the actual JSON messages exchanged during bidirectional communication:</p>
<h3 id="client-to-server-request">Client to Server Request</h3>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;method&quot;: &quot;sampling/createMessage&quot;,
  &quot;params&quot;: {
    &quot;messages&quot;: [
      {
        &quot;role&quot;: &quot;user&quot;,
        &quot;content&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;text&quot;: &quot;clinical_data={\&quot;diagnosis\&quot;: \&quot;Hypertension\&quot;, \&quot;blood_pressure\&quot;: \&quot;140/90\&quot;, \&quot;medication\&quot;: \&quot;Lisinopril 10mg\&quot;}&quot;
        }
      }
    ],
    &quot;modelPreferences&quot;: {
      &quot;hints&quot;: [
        {&quot;name&quot;: &quot;healthcare-model&quot;}
      ],
      &quot;intelligencePriority&quot;: 0.8,
      &quot;speedPriority&quot;: 0.5
    },
    &quot;maxTokens&quot;: 1000
  }
}
</code></pre>
<h3 id="server-to-client-response">Server to Client Response</h3>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 1,
  &quot;result&quot;: {
    &quot;role&quot;: &quot;assistant&quot;,
    &quot;content&quot;: {
      &quot;type&quot;: &quot;text&quot;,
      &quot;text&quot;: &quot;Additional information required: Need patient_id to associate with this clinical data.&quot;
    },
    &quot;model&quot;: &quot;emr-writeback-agent&quot;,
    &quot;stopReason&quot;: &quot;endTurn&quot;
  }
}
</code></pre>
<h3 id="follow-up-client-request-with-additional-data">Follow-up Client Request with Additional Data</h3>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;id&quot;: 2,
  &quot;method&quot;: &quot;sampling/createMessage&quot;,
  &quot;params&quot;: {
    &quot;messages&quot;: [
      {
        &quot;role&quot;: &quot;user&quot;,
        &quot;content&quot;: {
          &quot;type&quot;: &quot;text&quot;,
          &quot;text&quot;: &quot;clinical_data={\&quot;diagnosis\&quot;: \&quot;Hypertension\&quot;, \&quot;blood_pressure\&quot;: \&quot;140/90\&quot;, \&quot;medication\&quot;: \&quot;Lisinopril 10mg\&quot;} patient_id=PT12345&quot;
        }
      }
    ],
    &quot;maxTokens&quot;: 1000
  }
}
</code></pre>
<h3 id="error-response-when-guardrails-block-a-request">Error Response (When Guardrails Block a Request)</h3>
<pre><code class="language-json">{
  &quot;jsonrpc&quot;: &quot;2.0&quot;, 
  &quot;id&quot;: 3, 
  &quot;error&quot;: {
    &quot;code&quot;: -1, 
    &quot;message&quot;: &quot;Request blocked by guardrails&quot;
  }
}
</code></pre>
<h2 id="message-flow-in-a-multi-agent-system">Message Flow in a Multi-Agent System</h2>
<p>The following diagram depicts the message flow in a multi-agent healthcare scenario as implemented in the HMCP Demo:</p>
<pre><code class="language-mermaid">sequenceDiagram
    participant AI as AI Agent (Orchestrator)
    participant EMR as EMR Writeback Agent
    participant Patient as Patient Data Access Agent

    Note over AI,Patient: Workflow initialization

    AI-&gt;&gt;EMR: Start EMR Agent (StdioServerParameters)
    Note right of EMR: EMR Agent initializes&lt;br&gt;with HMCPServer and&lt;br&gt;registers sampling handler
    EMR--&gt;&gt;AI: Initialization response

    AI-&gt;&gt;Patient: Start Patient Agent (StdioServerParameters)
    Note right of Patient: Patient Agent initializes&lt;br&gt;with HMCPServer and&lt;br&gt;registers sampling handler
    Patient--&gt;&gt;AI: Initialization response

    AI-&gt;&gt;EMR: Connect to EMR via ClientSession
    EMR--&gt;&gt;AI: Connection established (emr_init_result)

    Note over AI,EMR: First clinical data request
    AI-&gt;&gt;EMR: create_message([clinical_data_message])
    Note right of EMR: Invokes handle_emr_writeback_sampling()
    EMR--&gt;&gt;AI: &quot;Additional information required: Need patient_id&quot;

    AI-&gt;&gt;Patient: Connect to Patient Agent via ClientSession
    Patient--&gt;&gt;AI: Connection established (patient_init_result)

    Note over AI,Patient: Patient ID request
    AI-&gt;&gt;Patient: create_message([patient_request_message])
    Note right of Patient: Invokes handle_patient_data_sampling()
    Patient--&gt;&gt;AI: &quot;Patient identifier for John Smith: patient_id=PT12345&quot;

    Note over AI,EMR: Final clinical data request with ID
    AI-&gt;&gt;EMR: create_message([clinical_data_with_id_message])
    Note right of EMR: Invokes handle_emr_writeback_sampling()
    EMR--&gt;&gt;AI: &quot;Success: Clinical data has been written to the EMR system&quot;

    Note over AI,Patient: Workflow completed
</code></pre>
<h2 id="security-and-guardrails-in-bidirectional-communication">Security and Guardrails in Bidirectional Communication</h2>
<p>Bidirectional communication introduces additional security concerns. HMCP addresses these with:</p>
<ol>
<li><strong>Authentication and Authorization</strong>: All sampling requests require OAuth 2.0 authentication with appropriate scopes</li>
<li><strong>Guardrails</strong>: Automatic validation of all messages passing between agents to prevent prompt injection</li>
<li><strong>Audit Logging</strong>: Comprehensive logging of all communications for compliance requirements</li>
</ol>
<p>Example of a sampling request blocked by guardrails:</p>
<pre><code class="language-mermaid">sequenceDiagram
    participant AI as AI Agent
    participant Guard as Guardrail System
    participant HMCP as HMCP Server

    AI-&gt;&gt;HMCP: Sampling request with prompt injection attempt
    HMCP-&gt;&gt;Guard: Check request against guardrails
    Guard--xHMCP: Block request (contains &quot;system prompt&quot;)
    HMCP--xAI: Return GuardrailException
    Note right of AI: Request blocked for security reasons
</code></pre>
<h2 id="use-cases-for-bidirectional-agent-communication">Use Cases for Bidirectional Agent Communication</h2>
<p>HMCP's bidirectional communication enables several healthcare-specific workflows:</p>
<ol>
<li><strong>Clinical Decision Support</strong>: Specialized agents providing evidence-based recommendations</li>
<li><strong>Data Transformation</strong>: Converting unstructured clinical notes to structured data</li>
<li><strong>Multi-agent Workflows</strong>: Complex healthcare processes involving multiple specialized agents</li>
<li><strong>Federated Knowledge</strong>: Accessing domain-specific knowledge without requiring all agents to have complete healthcare knowledge</li>
</ol>
<p>By implementing sampling on both clients and servers, HMCP creates a flexible ecosystem of healthcare AI agents that can collaborate securely and efficiently.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.highlight", "search.suggest"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>