
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://amitv-innovaccer.github.io/Healthcare-MCP/tutorial/03_authentication__oauth___jwt__/" rel="canonical"/>
<link href="../02_hmcp_client_/" rel="prev"/>
<link href="../04_sampling_functionality_/" rel="next"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.12" name="generator"/>
<title>03 Authentication (OAuth &amp; JWT) - Healthcare-MCP Docs</title>
<link href="../../assets/stylesheets/main.2afb09e1.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#chapter-3-authentication-oauth-jwt">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Healthcare-MCP Docs" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Healthcare-MCP Docs">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Healthcare-MCP Docs
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              03 Authentication (OAuth &amp; JWT)
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../specification/">
          
  
  
  Specification

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../specification/hmcp_python_sdk/">
          
  
  
  SDK

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../">
          
  
  
  Tutorial

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Healthcare-MCP Docs" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Healthcare-MCP Docs">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    Healthcare-MCP Docs
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    Specification
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            Specification
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../specification/">
<span class="md-ellipsis">
    Introduction
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../specification/context/">
<span class="md-ellipsis">
    Context
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../specification/auth/">
<span class="md-ellipsis">
    Auth
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../specification/hmcp_auth_vs_mcp_auth/">
<span class="md-ellipsis">
    HMCP Auth vs MCP Auth
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../specification/guardrails/">
<span class="md-ellipsis">
    Guardrails
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../specification/sampling/">
<span class="md-ellipsis">
    Sampling
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    SDK
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            SDK
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../specification/hmcp_python_sdk/">
<span class="md-ellipsis">
    HMCP Python SDK
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../specification/examples/">
<span class="md-ellipsis">
    HMCP Examples
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-ellipsis">
    Tutorial
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../">
<span class="md-ellipsis">
    Introduction
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../01_hmcp_server_/">
<span class="md-ellipsis">
    01 HMCP Server
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../02_hmcp_client_/">
<span class="md-ellipsis">
    02 HMCP Client
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    03 Authentication (OAuth &amp; JWT)
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    03 Authentication (OAuth &amp; JWT)
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#whats-the-problem-security">
<span class="md-ellipsis">
      What's the Problem? Security!
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-security-checkpoint-oauth-20-and-jwt">
<span class="md-ellipsis">
      The Security Checkpoint: OAuth 2.0 and JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#how-the-client-gets-an-access-token">
<span class="md-ellipsis">
      How the Client Gets an Access Token
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#how-it-works-under-the-hood-server-side">
<span class="md-ellipsis">
      How it Works Under the Hood: Server Side
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../04_sampling_functionality_/">
<span class="md-ellipsis">
    04 Sampling Functionality
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../05_guardrails_/">
<span class="md-ellipsis">
    05 Guardrails
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../06_auth_configuration_/">
<span class="md-ellipsis">
    06 Auth Configuration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../07_jwt_handler_/">
<span class="md-ellipsis">
    07 JWT Handler
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#whats-the-problem-security">
<span class="md-ellipsis">
      What's the Problem? Security!
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#the-security-checkpoint-oauth-20-and-jwt">
<span class="md-ellipsis">
      The Security Checkpoint: OAuth 2.0 and JWT
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#how-the-client-gets-an-access-token">
<span class="md-ellipsis">
      How the Client Gets an Access Token
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#how-it-works-under-the-hood-server-side">
<span class="md-ellipsis">
      How it Works Under the Hood: Server Side
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#conclusion">
<span class="md-ellipsis">
      Conclusion
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="chapter-3-authentication-oauth-jwt">Chapter 3: Authentication (OAuth &amp; JWT)</h1>
<p>In <a href="../02_hmcp_client_/">Chapter 2: HMCP Client</a>, we saw how our application (like a doctor's assistant) can use the <code>HMCPClient</code> to send requests, especially special ones like asking the <a href="../01_hmcp_server_/">HMCP Server</a> to generate text.</p>
<p>But wait! The HMCP Server often deals with sensitive healthcare information. We can't just let <em>any</em> application connect and ask for data or generate text. We need a security system. How does the server know <em>who</em> is making the request, and if they <em>have permission</em> to do so?</p>
<p>This chapter introduces <strong>Authentication</strong>, the process of verifying identity and permissions in the Healthcare-MCP project.</p>
<h2 id="whats-the-problem-security">What's the Problem? Security!</h2>
<p>Imagine our doctor's assistant application needs to fetch patient details or draft a message based on a patient's record. The HMCP Server holding this information needs to be absolutely sure that:</p>
<ol>
<li>The application requesting the data is legitimate and known (it's not some random program trying to snoop).</li>
<li>The application has the <em>right permissions</em> (or "scopes") for the specific action it wants to perform (e.g., maybe it can read general notes but not billing information).</li>
</ol>
<p>Think of the HMCP Server like a secure building (e.g., a hospital records room). You can't just walk in. You need to go to the security checkpoint at the entrance.</p>
<h2 id="the-security-checkpoint-oauth-20-and-jwt">The Security Checkpoint: OAuth 2.0 and JWT</h2>
<p>Our security checkpoint uses two standard industry tools:</p>
<ol>
<li>
<p><strong>OAuth 2.0 (Client Credentials Flow):</strong> This is the <em>process</em> for an application (our client) to get permission. Think of it as the procedure the security guard follows. The application presents its credentials (like a company ID badge and a secret password) to a specific "authentication desk" (<code>/oauth/token</code> endpoint) on the server. If the credentials are valid, the guard grants access. We specifically use the "Client Credentials" flow, which is designed for applications talking directly to servers (machine-to-machine).</p>
<ul>
<li><strong>Analogy:</strong> It's like a delivery driver showing their company ID and a specific delivery order form to the hospital loading dock security to get temporary access.</li>
</ul>
</li>
<li>
<p><strong>JWT (JSON Web Tokens):</strong> This is the <em>format</em> of the temporary access pass the server issues once the application proves its identity. It's a compact, secure string of characters that contains information about who the application is and what it's allowed to do (its "scopes").</p>
<ul>
<li><strong>Analogy:</strong> It's like a secure, digitally signed temporary ID card or key fob issued by the security guard. This card (the JWT) clearly states your name (Client ID) and which doors (scopes) you can open, and it has an expiry time. It's designed to be tamper-proof.</li>
</ul>
</li>
</ol>
<p><strong>Key Terms:</strong></p>
<ul>
<li><strong>Client ID:</strong> A public identifier for the application, like a username.</li>
<li><strong>Client Secret:</strong> A confidential password known only to the application and the server. <strong>Keep this secret!</strong></li>
<li><strong>Scope:</strong> A specific permission (e.g., <code>hmcp:access</code> to connect, <code>patient/hmcp:read</code> to read patient-related info).</li>
<li><strong>Access Token (JWT):</strong> The temporary pass (in JWT format) issued by the server after successful authentication. The client includes this token with every subsequent request.</li>
</ul>
<h2 id="how-the-client-gets-an-access-token">How the Client Gets an Access Token</h2>
<p>Before the <code>HMCPClient</code> can make requests like <code>create_message</code>, it first needs to get an Access Token (a JWT) from the server's authentication endpoint. Here's the simplified flow:</p>
<ol>
<li><strong>Client Prepares:</strong> The client application knows its <code>client_id</code> and <code>client_secret</code>.</li>
<li><strong>Client Asks for Token:</strong> It sends these credentials to the server's special authentication URL (e.g., <code>http://your-hmcp-server.com/oauth/token</code>).</li>
<li><strong>Server Checks:</strong> The server receives the request, checks if the <code>client_id</code> exists in its list of allowed clients (<a href="../06_auth_configuration_/">Auth Configuration</a>), and verifies the <code>client_secret</code>.</li>
<li><strong>Server Issues Token:</strong> If credentials are valid, the server generates a JWT Access Token containing the <code>client_id</code> and the scopes this client is allowed to use.</li>
<li><strong>Client Receives Token:</strong> The server sends the Access Token back to the client.</li>
</ol>
<p>Now the client can use this token to make actual API calls!</p>
<p><strong>Example: Using <code>OAuthClient</code> to Get a Token</strong></p>
<p>The <code>hmcp</code> library provides helpers for this. Let's see how a client might get a token.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Assume necessary imports and config setup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hmcp.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">AuthConfig</span><span class="p">,</span> <span class="n">OAuthClient</span><span class="p">,</span> <span class="n">ClientValidationError</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span> <span class="c1"># A library to make web requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="c1"># --- Configuration (Usually loaded securely) ---</span>
<span class="n">SERVER_URL</span> <span class="o">=</span> <span class="s2">"http://127.0.0.1:8050"</span> <span class="c1"># Where the HMCP server is running</span>
<span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="s2">"test-client"</span>
<span class="n">CLIENT_SECRET</span> <span class="o">=</span> <span class="s2">"test-secret"</span> <span class="c1"># Keep this safe!</span>

<span class="c1"># Load server's expected auth settings (needed by the client helper)</span>
<span class="c1"># In a real app, parts of this might come from the server's discovery endpoint</span>
<span class="n">auth_config</span> <span class="o">=</span> <span class="n">AuthConfig</span><span class="p">(</span>
    <span class="n">ALLOWED_CLIENTS</span><span class="o">=</span><span class="p">{</span><span class="n">CLIENT_ID</span><span class="p">:</span> <span class="p">{</span><span class="s2">"secret"</span><span class="p">:</span> <span class="n">CLIENT_SECRET</span><span class="p">,</span> <span class="s2">"scopes"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"hmcp:access"</span><span class="p">]}},</span>
    <span class="n">OAUTH_TOKEN_URL</span><span class="o">=</span><span class="s2">"/oauth/token"</span> <span class="c1"># The path for getting tokens</span>
<span class="p">)</span>

<span class="c1"># --- Function to get the token ---</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_access_token</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 1. Create the helper client</span>
        <span class="n">oauth_client</span> <span class="o">=</span> <span class="n">OAuthClient</span><span class="p">(</span>
            <span class="n">client_id</span><span class="o">=</span><span class="n">CLIENT_ID</span><span class="p">,</span>
            <span class="n">client_secret</span><span class="o">=</span><span class="n">CLIENT_SECRET</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">auth_config</span>
        <span class="p">)</span>

        <span class="c1"># 2. Prepare the request data (using the helper)</span>
        <span class="n">token_request_data</span> <span class="o">=</span> <span class="n">oauth_client</span><span class="o">.</span><span class="n">create_token_request</span><span class="p">(</span>
            <span class="n">scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">"hmcp:access"</span><span class="p">]</span> <span class="c1"># Ask for specific permissions</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Asking for token with data: </span><span class="si">{</span><span class="n">token_request_data</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># 3. Make the actual web request to the server's token endpoint</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">SERVER_URL</span><span class="si">}{</span><span class="n">auth_config</span><span class="o">.</span><span class="n">OAUTH_TOKEN_URL</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">token_request_data</span>
            <span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span> <span class="c1"># Raise an error for bad responses (like 401)</span>
            <span class="n">token_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="c1"># Get the JSON response</span>

        <span class="c1"># 4. Store the token (using the helper)</span>
        <span class="n">oauth_client</span><span class="o">.</span><span class="n">set_token</span><span class="p">(</span><span class="n">token_response</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Success! Received Access Token: </span><span class="si">{</span><span class="n">oauth_client</span><span class="o">.</span><span class="n">access_token</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">oauth_client</span><span class="o">.</span><span class="n">access_token</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">ClientValidationError</span><span class="p">,</span> <span class="n">httpx</span><span class="o">.</span><span class="n">HTTPStatusError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Authentication failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># --- Run the function (in a real app, this token is stored and used) ---</span>
<span class="c1"># access_token = asyncio.run(get_access_token())</span>
<span class="c1"># if access_token:</span>
<span class="c1">#    # Now you can use this token to make authenticated requests!</span>
<span class="c1">#    # The HMCPClient will use this token in its headers.</span>
<span class="c1">#    pass</span>
</code></pre></div>
<p><strong>Explanation:</strong></p>
<ol>
<li>We set up our server URL, client ID, and secret. We also create an <code>AuthConfig</code> object (which the <code>OAuthClient</code> helper needs).</li>
<li>We create an instance of <code>OAuthClient</code>, giving it our credentials and config.</li>
<li><code>oauth_client.create_token_request</code> helps format the data we need to send to the server (including the <code>grant_type: client_credentials</code>).</li>
<li>We use the <code>httpx</code> library to send a <code>POST</code> request to the server's <code>/oauth/token</code> endpoint with the request data.</li>
<li>If the server approves (doesn't return an error like 401 Unauthorized), we parse the JSON response.</li>
<li><code>oauth_client.set_token</code> stores the received <code>access_token</code> from the response inside the <code>oauth_client</code> object.</li>
<li>We print the first part of the token to show we got it. In a real app, this token would be stored and passed to the <code>HMCPClient</code> (often automatically by setting it in the <code>ClientSession</code>'s headers) for making authenticated calls like <code>create_message</code>.</li>
</ol>
<p><strong>Example Output (Success):</strong></p>
<div class="highlight"><pre><span></span><code>Asking for token with data: {'client_id': 'test-client', 'client_secret': 'test-secret', 'grant_type': 'client_credentials', 'scope': 'hmcp:access'}
Success! Received Access Token: eyJhbGciOiJIUzI...
</code></pre></div>
<p><strong>Example Output (Failure - e.g., wrong secret):</strong></p>
<div class="highlight"><pre><span></span><code>Asking for token with data: {'client_id': 'test-client', 'client_secret': 'wrong-secret', 'grant_type': 'client_credentials', 'scope': 'hmcp:access'}
Authentication failed: 401 Unauthorized for url `http://127.0.0.1:8050/oauth/token`
For more information check: https://httpstatuses.com/401
</code></pre></div>
<h2 id="how-it-works-under-the-hood-server-side">How it Works Under the Hood: Server Side</h2>
<p>When the client sends its credentials to <code>/oauth/token</code>, what happens on the <a href="../01_hmcp_server_/">HMCP Server</a>?</p>
<p><strong>Walkthrough:</strong></p>
<ol>
<li><strong>Request Arrives:</strong> The server's web framework (FastAPI/Starlette) routes the <code>POST</code> request to <code>/oauth/token</code> to the specific handler function designed for authentication.</li>
<li><strong>Credentials Extracted:</strong> The handler extracts the <code>client_id</code>, <code>client_secret</code>, <code>grant_type</code>, and requested <code>scope</code> from the request data.</li>
<li><strong>Validation:</strong> The <code>OAuthServer</code> logic checks:<ul>
<li>Is the <code>grant_type</code> supported (e.g., <code>client_credentials</code>)?</li>
<li>Does the <code>client_id</code> exist in the allowed clients list (<a href="../06_auth_configuration_/">Auth Configuration</a>)?</li>
<li>Does the provided <code>client_secret</code> match the stored secret for that client?</li>
<li>Are the requested <code>scopes</code> allowed for this client?</li>
</ul>
</li>
<li><strong>Token Generation:</strong> If validation passes, the <code>OAuthServer</code> calls the <a href="../07_jwt_handler_/">JWT Handler</a> (<code>JWTHandler.generate_token</code>) to create the JWT Access Token. This involves:<ul>
<li>Creating a "payload" (a dictionary) containing claims like <code>sub</code> (subject/client_id), <code>iss</code> (issuer), <code>exp</code> (expiry time), <code>aud</code> (audience - who the token is for), and <code>scope</code>.</li>
<li>Signing the payload using the server's secret key (<code>JWT_SECRET_KEY</code>) and algorithm (<code>JWT_ALGORITHM</code>) from the <a href="../06_auth_configuration_/">Auth Configuration</a>.</li>
</ul>
</li>
<li><strong>Response Sent:</strong> The <code>OAuthServer</code> packages the generated JWT into a JSON response (like <code>{"access_token": "...", "token_type": "Bearer", ...}</code>) and sends it back to the client with a <code>200 OK</code> status.</li>
</ol>
<p><strong>Sequence Diagram (Token Request):</strong></p>
<div class="mermaid">sequenceDiagram
    participant ClientApp as Client Application
    participant ServerEndpoint as Server (/oauth/token)
    participant OServer as OAuthServer Logic
    participant JWTH as JWT Handler
    participant Config as Auth Configuration

    ClientApp-&gt;&gt;+ServerEndpoint: POST /oauth/token (with Client ID, Secret, Scope)
    ServerEndpoint-&gt;&gt;+OServer: Handle Token Request(data)
    OServer-&gt;&gt;+Config: Get Allowed Clients &amp; Secrets
    OServer-&gt;&gt;OServer: Validate Credentials &amp; Scopes
    Note over OServer, Config: If Invalid: Return Error
    OServer-&gt;&gt;+JWTH: generate_token(client_id, scope)
    JWTH-&gt;&gt;+Config: Get JWT Secret Key, Algorithm, Expiry
    JWTH-&gt;&gt;JWTH: Create JWT Payload (sub, exp, scope...)
    JWTH-&gt;&gt;JWTH: Sign Token
    JWTH--&gt;&gt;-OServer: Return Signed JWT (Access Token)
    OServer--&gt;&gt;-ServerEndpoint: Format JSON Response (with Token)
    ServerEndpoint--&gt;&gt;-ClientApp: Send JSON Response (200 OK)

</div>
<p><strong>Key Server Code Snippets:</strong></p>
<ul>
<li>
<p><strong>OAuth Token Endpoint Handler (Conceptual - part of the web server setup):</strong> This function receives the web request.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Conceptual handler for POST /oauth/token</span>
<span class="c1"># (Actual implementation uses FastAPI/Starlette routing)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_token_request</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="n">form_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">()</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"client_id"</span><span class="p">)</span>
    <span class="n">client_secret</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"client_secret"</span><span class="p">)</span>
    <span class="c1"># ... get grant_type, scope ...</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Assume 'oauth_server' is an instance of OAuthServer</span>
        <span class="c1"># 1. Validate client (simplified)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">oauth_server</span><span class="o">.</span><span class="n">validate_client</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">):</span>
             <span class="k">raise</span> <span class="n">ClientValidationError</span><span class="p">(</span><span class="s2">"Invalid credentials"</span><span class="p">)</span>

        <span class="c1"># 2. Check scopes are allowed for this client (simplified)</span>
        <span class="c1"># ... scope validation logic ...</span>

        <span class="c1"># 3. Create the token</span>
        <span class="n">token_response</span> <span class="o">=</span> <span class="n">oauth_server</span><span class="o">.</span><span class="n">create_token</span><span class="p">(</span>
            <span class="n">client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"scope"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">token_response</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">ClientValidationError</span><span class="p">,</span> <span class="n">ScopeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">"error"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span> <span class="c1"># Or 403</span>
</code></pre></div>
</li>
<li>
<p><strong><code>OAuthServer.create_token</code> (from <code>src/hmcp/auth/oauth_server.py</code>):</strong> This orchestrates token creation.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Inside src/hmcp/auth/oauth_server.py (simplified)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OAuthServer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">AuthConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># The JWT Handler does the actual JWT work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jwt_handler</span> <span class="o">=</span> <span class="n">JWTHandler</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="c1"># ... (client registration logic omitted) ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="c1"># Calls the JWT Handler to generate the token string</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jwt_handler</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">)</span>

        <span class="c1"># Packages the token into the standard OAuth2 response format</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'access_token'</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
            <span class="s1">'token_type'</span><span class="p">:</span> <span class="s1">'Bearer'</span><span class="p">,</span>
            <span class="s1">'expires_in'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">TOKEN_EXPIRY_HOURS</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
            <span class="s1">'scope'</span><span class="p">:</span> <span class="n">scope</span>
        <span class="p">}</span>
        <span class="c1"># ... (add patient claim if needed) ...</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>
</li>
<li>
<p><strong><code>JWTHandler.generate_token</code> (from <code>src/hmcp/auth/jwt_handler.py</code>):</strong> This creates and signs the JWT. (See also <a href="../07_jwt_handler_/">JWT Handler</a>).</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Inside src/hmcp/auth/jwt_handler.py (simplified)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jwt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyjwt</span> <span class="c1"># The PyJWT library</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JWTHandler</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">AuthConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># 1. Prepare the data (payload) inside the token</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'iss'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ISSUER</span><span class="p">,</span>          <span class="c1"># Who issued the token</span>
            <span class="s1">'sub'</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>                   <span class="c1"># Subject (who the token is about)</span>
            <span class="s1">'aud'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">JWT_AUDIENCE</span><span class="p">,</span>    <span class="c1"># Audience (who should accept it)</span>
            <span class="s1">'iat'</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>                         <span class="c1"># Issued At time</span>
            <span class="s1">'exp'</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">TOKEN_EXPIRY_HOURS</span><span class="p">),</span> <span class="c1"># Expiry time</span>
            <span class="s1">'scope'</span><span class="p">:</span> <span class="n">scope</span>                      <span class="c1"># Granted permissions</span>
        <span class="p">}</span>
        <span class="c1"># ... (add patient claim if needed) ...</span>

        <span class="c1"># 2. Use pyjwt library to encode and sign the token</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">pyjwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">payload</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">JWT_SECRET_KEY</span><span class="p">,</span> <span class="c1"># The crucial secret key!</span>
            <span class="n">algorithm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">JWT_ALGORITHM</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span>
</code></pre></div>
</li>
</ul>
<p><strong>What about using the token?</strong></p>
<p>Once the client has the token, it includes it in the <code>Authorization</code> header of subsequent requests (like the <code>create_message</code> request from Chapter 2):</p>
<p><code>Authorization: Bearer eyJhbGciOiJIUzI...</code></p>
<p>The <code>AuthMiddleware</code> on the server (discussed briefly in <a href="../01_hmcp_server_/">Chapter 1: HMCP Server</a> and implemented in <code>src/hmcp/mcpserver/fastmcp_auth.py</code>) intercepts these requests. It extracts the token, uses the <code>JWTHandler.verify_token</code> method to check its signature, expiry, and claims (like scopes), and either allows the request to proceed or rejects it with an error (like <code>401 Unauthorized</code> or <code>403 Forbidden</code>).</p>
<h2 id="conclusion">Conclusion</h2>
<p>You've learned about the crucial role of Authentication in securing the HMCP Server. We saw how the server acts like a security checkpoint, using the <strong>OAuth 2.0</strong> standard (specifically the Client Credentials flow) as the process for applications to request access by providing their <strong>Client ID</strong> and <strong>Client Secret</strong>.</p>
<p>If successful, the server issues a <strong>JWT Access Token</strong> â€“ a secure, temporary pass containing the client's identity and allowed <strong>scopes</strong> (permissions). The client then uses this token in the <code>Authorization</code> header for all future requests. We peeked at how the <code>OAuthClient</code> helps the client get a token and how the <code>OAuthServer</code> and <a href="../07_jwt_handler_/">JWT Handler</a> work together on the server side to validate credentials and generate these secure tokens.</p>
<p>Now that we understand how a client gets permission to talk to the server, we can explore one of the server's most powerful features: its ability to generate text based on prompts.</p>
<p>Let's move on to <a href="../04_sampling_functionality_/">Chapter 4: Sampling Functionality</a>!</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.highlight", "search.suggest"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>